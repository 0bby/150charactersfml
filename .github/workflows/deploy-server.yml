name: Deploy Server to EC2

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'raylib/game.h'
      - 'raylib/helpers.c'
      - 'raylib/helpers.h'
      - 'raylib/combat_sim.c'
      - 'raylib/combat_sim.h'
      - 'raylib/net_common.c'
      - 'raylib/net_common.h'
      - 'raylib/net_protocol.h'
      - 'raylib/leaderboard.c'
      - 'raylib/leaderboard.h'
      - 'raylib/abilities_cast.c'
      - 'raylib/abilities.h'
      - 'raylib/unit_stats.h'
      - 'raylib/synergies.h'
      - 'raylib/pve_waves.h'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Upload server sources
        run: |
          rsync -avz --delete \
            --include='*.c' --include='*.h' --include='Makefile' \
            --exclude='*' \
            server/ \
            -e "ssh -i ~/.ssh/key.pem" \
            ec2-user@${{ secrets.EC2_HOST }}:~/server/

      - name: Upload shared raylib sources
        run: |
          rsync -avz \
            raylib/combat_sim.c raylib/combat_sim.h \
            raylib/helpers.c raylib/helpers.h \
            raylib/net_common.c raylib/net_common.h \
            raylib/net_protocol.h \
            raylib/leaderboard.c raylib/leaderboard.h \
            raylib/abilities_cast.c raylib/abilities.h \
            raylib/game.h raylib/unit_stats.h \
            raylib/synergies.h raylib/pve_waves.h \
            -e "ssh -i ~/.ssh/key.pem" \
            ec2-user@${{ secrets.EC2_HOST }}:~/raylib/

      - name: Build and restart server
        run: |
          ssh -i ~/.ssh/key.pem ec2-user@${{ secrets.EC2_HOST }} '
            cd ~/server && \
            make clean && make && \
            pkill server || true && \
            nohup ./server > /tmp/server.log 2>&1 &
            sleep 1 && pgrep server && echo "Server started successfully" || echo "WARNING: Server may not have started"
          '
